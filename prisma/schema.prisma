// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Category {
  id           String    @id @default(cuid())
  name         String    @unique
  isActive     Boolean   @default(true)
  displayOrder Int       @default(0)
  products     Product[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Product {
  id           String               @id @default(cuid())
  name         String
  description  String?
  price        Decimal              @db.Decimal(10, 2)
  imageUrl     String?
  isAvailable  Boolean              @default(true)
  isFeatured   Boolean              @default(false)
  displayOrder Int                  @default(0)
  calories     Int?
  // allergens    String[]
  category     Category             @relation(fields: [categoryId], references: [id])
  categoryId   String
  tags         ProductTag[]
  optionGroups ProductOptionGroup[]
  orderItems   OrderItem[]
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
}

model ProductTag {
  id        String    @id @default(cuid())
  name      String    @unique // e.g., "Spicy", "Vegetarian"
  color     String? // hex color code
  icon      String? // icon name
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ProductOptionGroup {
  id         String          @id @default(cuid())
  name       String // e.g., "Size", "Toppings"
  minSelect  Int             @default(0)
  maxSelect  Int             @default(1)
  isRequired Boolean         @default(false)
  options    ProductOption[]
  product    Product         @relation(fields: [productId], references: [id])
  productId  String
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
}

model ProductOption {
  id            String             @id @default(cuid())
  name          String
  price         Decimal            @default(0.00) @db.Decimal(10, 2)
  isAvailable   Boolean            @default(true)
  optionGroup   ProductOptionGroup @relation(fields: [optionGroupId], references: [id])
  optionGroupId String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
}

model RestaurantTable {
  id          String      @id @default(cuid())
  tableNumber String      @unique
  capacity    Int         @default(2)
  status      TableStatus @default(AVAILABLE)
  qrCode      String?     @unique
  orders      Order[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Order {
  id            String           @id @default(cuid())
  status        OrderStatus      @default(PENDING)
  type          OrderType        @default(DINE_IN)
  totalAmount   Decimal          @db.Decimal(10, 2)
  notes         String?
  table         RestaurantTable? @relation(fields: [tableId], references: [id])
  tableId       String?
  tableNumber   String? // Fallback for manual entry
  items         OrderItem[]
  paymentStatus PaymentStatus    @default(PENDING)
  paymentMethod PaymentMethod?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

model OrderItem {
  id              String   @id @default(cuid())
  quantity        Int
  price           Decimal  @db.Decimal(10, 2) // Price at the time of order
  notes           String?
  selectedOptions Json? // Array of selected option objects
  product         Product  @relation(fields: [productId], references: [id])
  productId       String
  order           Order    @relation(fields: [orderId], references: [id])
  orderId         String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Staff {
  id                      Int            @id @default(autoincrement())
  email                   String         @unique
  name                    String         @db.VarChar(50)
  role                    Role           @default(ADMIN)
  password                String         @db.VarChar(100)
  pictureUrl              String         @default("")
  rank                    Rank           @default(NONE)
  authType                String         @default("ID,PW")
  prevPassword            String         @default("")
  isEmailVerified         String         @default("N")
  accountLockYn           String         @default("N")
  lastLoginDate           Decimal?       @db.Decimal(20, 3)
  loginFailCnt            Int            @default(0)
  mfaEnabledYn            String         @default("N")
  mfaSecretKey            String?        @default("")
  tempPassword            String?
  resetTokenExpires       Decimal?       @db.Decimal(20, 3)
  resetToken              String?
  phone                   String         @default("")
  otpCode                 String?
  otpExpire               Decimal?       @db.Decimal(20, 3)
  baseSalary              Float?
  department              Department?
  employeeNo              String?        @unique
  hireDate                Decimal?       @db.Decimal(20, 3)
  status                  EmployeeStatus @default(ACTIVE)
  fromTransferAdminUserYn String?        @default("N")
  toTransferAdminUserYn   String?        @default("N")
  isDeleted               Boolean        @default(false)
  attendance              Attendance[]
  leaveRequest            LeaveRequest[]
  payrolls                Payroll[]
  transferAdmin           TransferAdmin?
  sessions                UserSession[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  // unlockRequests UnlockRequest[]
}

model RolePermission {
  id          String @id @default(uuid())
  role        Role   @unique
  permissions Json

  createdAt Decimal @db.Decimal(20, 3)
  updatedAt Decimal @db.Decimal(20, 3)
}

model PermissionDefinition {
  id          String  @id @default(uuid())
  key         String  @unique // e.g., "FLIGHT_VIEW", "FLIGHT_CREATE"
  category    String
  action      String // e.g., "VIEW", "CREATE", "EDIT", "DELETE"
  description String? // Human-readable description
  isActive    Boolean @default(true) // Can be disabled without deleting
  createdAt   Decimal @db.Decimal(20, 3)
  updatedAt   Decimal @db.Decimal(20, 3)

  @@index([category])
  @@index([isActive])
}

model TransferAdmin {
  id          Int            @id @default(autoincrement())
  userId      Int            @unique
  fromUserId  Int
  toUserId    Int
  status      TransferStatus @default(PENDING)
  requestedAt Decimal        @db.Decimal(20, 3)
  approvedAt  Decimal?       @db.Decimal(20, 3)
  staff       Staff          @relation(fields: [userId], references: [id])
}

model UserSession {
  id         Int        @id @default(autoincrement())
  userId     Int?
  token      String     @db.Text
  createdAt  Decimal?   @db.Decimal(20, 3)
  browser    String?
  device     String?
  ipAddress  String?
  isCurrent  Boolean    @default(false)
  location   String?
  userAgent  String?
  customerId String?
  customers  Customers? @relation(fields: [customerId], references: [id], onDelete: Cascade)
  staff      Staff?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_usersession_userId")
  @@index([customerId], map: "idx_usersession_customerId")
}

model Customers {
  id              String         @id @default(cuid())
  fullName        String
  email           String         @unique
  phone           String
  passport        String
  accountLockYn   String         @default("N")
  isEmailVerified String         @default("Y")
  lastLoginDate   Decimal?       @db.Decimal(20, 3)
  password        String?        @db.VarChar(100)
  status          EmployeeStatus @default(ACTIVE)
  otpCode         String?
  otpExpire       Decimal?       @db.Decimal(20, 3)
  role            Role           @default(CUSTOMER)
  loginFailCnt    Int            @default(0)
  mfaEnabledYn    String         @default("N")
  mfaSecretKey    String?        @default("")
  sessions        UserSession[]
}

model Payroll {
  id          Int           @id @default(autoincrement())
  employeeId  Int
  month       Int
  year        Int
  baseSalary  Float
  allowances  Float         @default(0)
  deductions  Float         @default(0)
  tax         Float         @default(0)
  netPay      Float
  status      PayrollStatus @default(DRAFT)
  generatedAt Decimal       @db.Decimal(20, 3)
  staff       Staff         @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, month, year])
  @@index([employeeId])
}

model Attendance {
  id          Int              @id @default(autoincrement())
  employeeId  Int
  date        Decimal          @db.Decimal(20, 3)
  checkIn     Decimal          @db.Decimal(20, 3)
  checkOut    Decimal          @db.Decimal(20, 3)
  status      AttendanceStatus @default(PRESENT)
  workedHours Float?
  note        String?
  createdAt   Decimal          @db.Decimal(20, 3)
  staff       Staff            @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@index([employeeId])
}

model HolidayTrip {
  id            Int            @id @default(autoincrement())
  destination   String
  description   String?        @db.Text
  startDate     Decimal        @db.Decimal(20, 3)
  endDate       Decimal        @db.Decimal(20, 3)
  createdAt     Decimal        @db.Decimal(20, 3)
  updatedAt     Decimal        @db.Decimal(20, 3)
  leaveRequests LeaveRequest[]
}

model LeaveRequest {
  id            Int          @id @default(autoincrement())
  employeeId    Int
  leaveType     String
  startDate     Decimal      @db.Decimal(20, 3)
  endDate       Decimal      @db.Decimal(20, 3)
  days          Float
  reason        String?
  status        LeaveStatus  @default(PENDING)
  approverId    Int?
  approverNote  String?
  appliedAt     Decimal      @db.Decimal(20, 3)
  decidedAt     Decimal?     @db.Decimal(20, 3)
  staff         Staff        @relation(fields: [employeeId], references: [id])
  holidayTripId Int?
  holidayTrip   HolidayTrip? @relation(fields: [holidayTripId], references: [id])

  @@index([holidayTripId])
  @@index([employeeId])
}

model UnlockRequest {
  id         Int          @id @default(autoincrement())
  reason     String       @db.Text
  status     UnlockStatus @default(PENDING)
  createdAt  Decimal      @db.Decimal(20, 3)
  approvedAt Decimal?     @db.Decimal(20, 3)
  employeeId Int
  // staff      Staff        @relation(fields: [employeeId], references: [id])

  @@index([employeeId], map: "UnlockRequest_employeeId_fkey")
}

enum OrderStatus {
  PENDING
  PREPARING
  SERVED
  COMPLETED
  CANCELLED
}

enum OrderType {
  DINE_IN
  TAKE_AWAY
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  OUT_OF_SERVICE
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  MOMO
  ZALOPAY
  STRIPE
}

enum TransferStatus {
  PENDING
  SUCCESS
  FAILED
  CANCELLED
}

enum Role {
  GUEST
  CUSTOMER
  ADMIN
  MONITOR
}

enum Rank {
  NONE
  SILVER
  GOLD
  PLATINUM
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum UnlockStatus {
  PENDING
  APPROVED
  REJECTED
}

enum BoardingStatus {
  PENDING
  BOARDED
  EXPIRED
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TERMINATED
}

enum FlightType {
  roundtrip
  oneway
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  ON_LEAVE
  REMOTE
}

enum PayrollStatus {
  DRAFT
  FINALIZED
  PAID
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  PAID
}

enum Department {
  HR
  IT
  FINANCE
  OPS
  SECURITY
  OTHER
}

enum Position {
  INTERN
  STAFF
  SENIOR
  MANAGER
  DIRECTOR
  EXECUTIVE
}
